function psd_pwelch(cfg)
%RUN_PWELCH Function that runs pwelch across subjects on the source
% parcellated data and saved the results in PSD files.
% input takes configurations with parcellated alpha power trials.

%% add relevant paths and define information
clc
basepath = '/home/mpib/stojanovic';

fieldtrip_dir = '/home/mpib/stojanovic/fieldtrip-20220104/';
% fieldtrip_dir = '/Volumes/LNDG/Projects/HCP/Sourceproject/fieldtrip-20220104/';
addpath(fieldtrip_dir);

datdir = '/home/mpib/stojanovic/PSDDATA/';
addpath(datdir);

ff = filesep; % based on the operating system (different for Mac v Windows)

ft_defaults()

%% run pwelch on the parcellated trials
% The function squeezes the data to remove singleton dimensions.
% The window length here is specified with a length of 500 samples, with an
% overlap of 50%. the frequencies are returned in steps of .5. 
% The estimates of power spectral density are returned in spec, and the
% corresponding frequencies are returned in f. 
% spec is a two-dimensional array of the shape nFreqs x nParcels,
% while f is a one-dimensional array of the shape nFreqs.

[spec,f] = pwelch((squeeze(parc_trls.trial(1,:,:)))',[],[],[1:.5:100],500);

%% save the PSD estimates for each parcel per subject

% save parcellated alpha data
save([datdir 'PSD' ff 'CompVar_PSD' ff cell2mat(subjno)], 'spec',...
        '-V7.3')
% also save dummy source
save([datdir 'PSD' ff 'CompVar_PSD' ff cell2mat(subjno)], 'f',...
        '-V7.3')

end
